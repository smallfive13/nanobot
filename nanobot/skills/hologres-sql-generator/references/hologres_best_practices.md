# Hologres SQL 最佳实践指南

本指南旨在为生成高性能、高鲁棒性的阿里云 Hologres SQL 提供标准规范。在编写 SQL 时，应严格遵循以下原则，以确保查询的准确性和执行效率。

## 数据类型与日期处理

Hologres 对数据类型的匹配要求非常严格。在进行不同数据类型之间的算术运算或逻辑比较时，必须通过显式类型转换（使用 `::type` 语法）来确保精度和兼容性。例如，在计算比率时，应将分子和分母均转换为 `float` 或 `numeric` 类型。

对于日期和时间的操作，推荐使用 `TO_CHAR` 函数进行格式化，或使用 `DATE_TRUNC` 进行时间粒度的截断。这不仅能提高代码的可读性，也有助于 Hologres 引擎更好地利用时间维度的索引。

| 操作类型 | 推荐做法 | 示例代码 |
| :--- | :--- | :--- |
| **类型转换** | 使用 `::type` 显式声明 | `SUM(amount)::float` |
| **日期格式化** | 使用 `TO_CHAR` 转换为字符串 | `TO_CHAR(call_day, 'YYYYMMDD')` |
| **时间截断** | 使用 `DATE_TRUNC` 按粒度对齐 | `DATE_TRUNC('day', timestamp)` |

## 鲁棒性与防御性编程

为了防止查询在运行时因异常数据而中断，必须在 SQL 中加入防御性逻辑。最常见的风险是“除零错误”，因此所有除法运算的分母都应当包裹在 `NULLIF(denominator, 0)` 函数中。此外，对于聚合计算的结果，应当使用 `COALESCE` 函数处理可能出现的 `NULL` 值，确保输出结果的连续性和业务逻辑的完整性。

> **核心公式**：`COALESCE(SUM(numerator)::float / NULLIF(SUM(denominator), 0), 0)`

## 查询结构优化

在引用表名和字段名时，应当始终使用双引号 `"` 进行包裹。这一做法可以有效避免与 SQL 关键字冲突，并能正确处理 Hologres 中大小写敏感的标识符。为了简化复杂的聚合查询，可以在 `GROUP BY` 子句中使用数字索引（如 `1, 2, 3`）来对应 `SELECT` 列表中的字段位置。

| 优化项 | 规范要求 | 预期收益 |
| :--- | :--- | :--- |
| **标识符引用** | 使用双引号包裹表名和字段名 | 避免关键字冲突，处理特殊字符 |
| **分组简化** | 使用数字索引进行 `GROUP BY` | 减少冗余代码，降低维护成本 |
| **过滤条件** | 优先使用索引字段作为过滤条件 | 提升查询响应速度，减少全表扫描 |

## 常用函数参考

在构建复杂逻辑时，合理利用 Hologres 的内置函数可以显著提升代码质量。

- **`COALESCE(val1, val2, ...)`**：返回参数列表中的第一个非空值，常用于设置默认值。
- **`NULLIF(val1, val2)`**：当两个参数相等时返回 `NULL`，常用于除法运算的分母保护。
- **`REGEXP_REPLACE(string, pattern, replacement)`**：利用正则表达式进行字符串替换，适用于复杂的数据清洗场景。
